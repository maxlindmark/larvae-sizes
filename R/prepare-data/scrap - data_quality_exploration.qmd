---
title: "Explore data"
author: "Max Lindmark"
date: today
date-format: iso
format: 
  html:
    page-layout: full
    embed-resources: true
knitr: 
  opts_chunk:
    fig.align: center
    out-width: 100%
editor: source
---

```{r load libraries}
#| message: false
#| warning: false

# Load libraries
library(tidyverse)
library(tidylog)
library(sdmTMB)
library(patchwork)
library(viridis)
library(RColorBrewer)
library(modelr)
library(ggstats)
library(ggspatial)
library(ggsidekick); theme_set(theme_sleek())

home <- here::here()
source(paste0(home, "/R/functions/map-plot.R"))
```

Read data and prediction grid, scales variables

```{r data}
#| message: false
#| fig-height: 14
# Read data
d <- readr::read_csv(paste0(home, "/data/clean/larval_size.csv")) %>% 
  drop_na(temp) %>%
  drop_na(chl) %>%
  drop_na(depth) %>%
  mutate(
    temp_sc = (temp - mean(temp, na.rm = TRUE)) / sd(temp, na.rm = TRUE),
    chl_sc = (chl - mean(chl, na.rm = TRUE)) / sd(chl, na.rm = TRUE),
    depth_sc = (depth - mean(depth, na.rm = TRUE)) / sd(depth, na.rm = TRUE),
    yday_ct = yday - mean(yday),
    year_f = as.factor(year),
    species_f = as.factor(species),
    year_ct = year - median(year)
    )

d %>% 
  ggplot(aes(year, length_mm)) + 
  scale_y_continuous(breaks = seq(0, 200, by = 10)) +
  scale_x_continuous(breaks = seq(1993, 2023, by = 8)) +
  facet_wrap(~species, scales = "free_y", ncol = 3) + 
  geom_point(alpha = 0.3, size = 0.8) +
  theme_sleek(base_size = 9)
```

## Notes
- Sizes are here transition to post-larvae (after which they metamorphose into juveniles). In some cases, the distribution of sizes overlap a lot with the postlarve size. In those cases we go for the size where they move from pelagic to benthic habitats (which often is what splits the size-distributions). Some species are also not larvae.
  - Agonus cataphractus: Trim the 3 data points above postlarvale sizes of 20 mm
  - Ammodytidae: Two species, don't foget to add ammodyteas into this group in the data processing script, since identification to species level likely has changed over time! There also appears to be two cohorts. Post-larvae cutoff at 26-30 mm cutoff at post-larvae for the two species, but here perhaps we want to split around 55 mm to separate the clusters?
  - Anguilla anguilla: Ok 
  - Aphia minuta: not larvae but can include anyway. Remove the one outlier
  - Argentina silus: Merge with argentna spp? Seems like identification to species level changed over time. Post larvae under 50 which seems fitting for a cutoff size
  - Chirolophis ascanii: Post-larvae around 20 mm. However, data indicate a size for metamorphosis around 30 mm (since they then settle on the seabead).
  - Clupea harengus: Post-larve until 48-50 mm, seems fitting
  - Crystallogobius linearis: Adult, otherwise seems OK. Malin was going to check something with the gear: are we sampling a different part of the size-distribution now?
  - Enchelyopus cimbrius: Potentially different cohorts because spawning time is long and potentially not accurate in the literature given the sizes we observe here. <span style="color:red;">Drop this from the study</span>
  - Limanda limanda: Post-larve may remain pelagic until 30 mm, use that as a cutoff.
  - Maurolicus muelleri: These are not larvae and not spawning frequently here. <span style="color:red;">Drop this from the study</span> 
  Microstomus kitt: metamorphosis at 18 mm, but still pelagic? we judge that they are pelagic until 40 mm
  - Myoxocephalus scorpius: Pelagic until about 20 mm, use that as a cutoff
  - Pholis gunnellus: pelagic until 35 mm, use that as a cutoff
  - Pomatoschistus sp: Not larve, could keep for the same reason as other non-larvae species
  - Sardina pilchardus: Ok
  - Sprattus sprattus: Too many adults because they don't spawn at the right time. If we trim to postlarvae, then we have too few anyway. <span style="color:red;">Drop this from the study</span>
  - Syngnathus rostellatus: No larval stage, can keep for the same reason as other non-larvae
  - Taurulus bubalis: 12 mm cutoff (is that post-larva maximum size or start?)